<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Portfolios - PropertyHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .portfolio-card { position: relative; }
        .favorite-btn { position: absolute; top: 1rem; right: 1rem; background: rgba(255, 255, 255, 0.95); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.25rem; cursor: pointer; transition: all 0.3s ease; z-index: 10; color: #cbd5e1; }
        .favorite-btn:hover { background: white; transform: scale(1.1); }
        .favorite-btn.active { color: #ef4444; }

         .delete-btn-admin {
        right: 4.5rem; /* Move 4.5rem from the right */
        color: #ef4444; /* Red trash icon */
    }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <a href="index.html">
                <i class="fas fa-home"></i>
                PropertyHub
            </a>
        </div>
        <div class="nav-menu">
            <a href="properties.html" class="nav-link">Browse Properties</a>
            <a href="portfolios.html" class="nav-link active">Browse Portfolios</a>
            <a href="favorites.html" class="nav-link" id="favoritesLink" style="display: none;">
                <i class="fas fa-heart"></i> Favorites
            </a>
            <div class="auth-buttons" id="authButtons">
                <a href="login.html" class="btn btn-outline">Login</a>
                <a href="register.html" class="btn btn-primary">Register</a>
            </div>
            <div class="user-menu" id="userMenu" style="display: none;">
                <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>
</nav>

<div class="page-header">
    <div class="container">
        <h1>Browse Portfolios</h1>
        <p>Connect with experienced real estate professionals</p>
    </div>
</div>

<div class="search-section">
    <div class="container">
        <div class="search-form">
            <div class="search-input-group">
                <input type="text" id="searchInput" placeholder="Search by name or expertise...">
                <button class="btn btn-primary" onclick="searchPortfolios()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>

            <div class="filter-controls">
                <select id="sortBy">
                    <option value="experience">Most Experienced</option>
                    <option value="name">Name A-Z</option>
                    <option value="newest">Newest First</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="loading" id="portfoliosLoading">
        <i class="fas fa-spinner fa-spin"></i> Loading portfolios...
    </div>

    <div class="portfolios-grid" id="portfoliosGrid"></div>
</div>

<div id="messageContainer" class="message-container"></div>

<script src="script.js"></script>
<script>
    let allPortfolios = [];
    let filteredPortfolios = [];
    let userFavorites = new Set();
    let isAdminUser = false; // âš¡ï¸ NEW: Flag to store admin status

    document.addEventListener('DOMContentLoaded', async function() {
        updateNavigation();

        // âš¡ï¸ NEW: Check admin status on load (assuming checkAdminStatus is available)
        isAdminUser = await checkAdminStatus();

        if (isAuthenticated()) {
            document.getElementById('favoritesLink').style.display = 'block';
            await loadUserFavorites();
        }

        await loadPortfolios();

        document.getElementById('searchInput').addEventListener('input', searchPortfolios);
        document.getElementById('sortBy').addEventListener('change', sortPortfolios);
    });

    // âš¡ï¸ IMPORTANT: You MUST include or ensure the checkAdminStatus function is available
    // Example (assuming it's in script.js or another function block):
    async function checkAdminStatus() {
        if (!isAuthenticated()) return false;
        try {
            // Adjust endpoint if needed, assuming /user/profile returns the role
            const userProfile = await makeRequest('/user/profile', 'GET', null, true);
            return userProfile && userProfile.role === 'ADMIN';
        } catch (error) {
            console.error('Failed to load user profile or check admin status:', error);
            return false;
        }
    }


    async function loadUserFavorites() {
        try {
            const favorites = await makeRequest('/favorites', 'GET', null, true);
            // Convert to numbers to ensure type consistency
            userFavorites = new Set(
                favorites
                    .filter(f => f.portfolio !== null && f.portfolio.id)
                    .map(f => Number(f.portfolio.id))
            );
            console.log('Loaded portfolio favorites:', Array.from(userFavorites));
        } catch (error) {
            console.error('Failed to load favorites:', error);
        }
    }

    async function loadPortfolios() {
        const loadingElement = document.getElementById('portfoliosLoading');
        const portfoliosGrid = document.getElementById('portfoliosGrid');

        try {
            const portfolios = await makeRequest('/portfolio/search', 'GET', null, false);

            loadingElement.style.display = 'none';
            allPortfolios = portfolios;
            filteredPortfolios = [...portfolios];

            if (portfolios.length === 0) {
                portfoliosGrid.innerHTML = '<div class="empty-state">No portfolios found</div>';
                return;
            }

            displayPortfolios();

        } catch (error) {
            loadingElement.style.display = 'none';
            portfoliosGrid.innerHTML = '<div class="error-state">Failed to load portfolios</div>';
            showMessage('Failed to load portfolios: ' + error.message, 'error');
        }
    }

    function displayPortfolios() {
        const portfoliosGrid = document.getElementById('portfoliosGrid');

        portfoliosGrid.innerHTML = filteredPortfolios.map(portfolio => {
            return `
            <div class="portfolio-card">
                ${isAuthenticated() ? `
                <button class="favorite-btn ${userFavorites.has(portfolio.id) ? 'active' : ''}"
                        onclick="event.stopPropagation(); toggleFavorite(${portfolio.id}, this)">
                    <i class="fas fa-heart"></i>
                </button>` : ''}

                ${isAdminUser ? `
                <button class="favorite-btn delete-btn-admin"
                        onclick="event.stopPropagation(); deletePortfolio(${portfolio.id})">
                    <i class="fas fa-trash"></i>
                </button>` : ''}

                <div onclick="viewPortfolio(${portfolio.id})">
                    <div class="portfolio-header">
                        <div class="portfolio-avatar">
                            ${portfolio.dp
                                ? `<img src="${getImageUrl(portfolio.dp)}" alt="${portfolio.title}" class="avatar-img">`
                                : `<i class="fas fa-user"></i>`}
                        </div>

                        <div class="portfolio-info">
                            <h3>${portfolio.title || 'Untitled Portfolio'}</h3>
                            <p class="portfolio-category">
                                <i class="fas fa-briefcase"></i>
                                ${portfolio.category || 'Uncategorized'}
                            </p>
                        </div>
                    </div>

                    <div class="portfolio-content">
                        <p class="portfolio-description">
                            ${portfolio.description
                                ? portfolio.description.substring(0, 150) + (portfolio.description.length > 150 ? '...' : '')
                                : 'No description available'}
                        </p>

                        <div class="portfolio-actions">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); viewPortfolio(${portfolio.id})">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }

    // âš¡ï¸ NEW FUNCTION: Handles the portfolio deletion
    async function deletePortfolio(portfolioId) {
        if (!confirm('Are you sure you want to delete this portfolio? This action cannot be undone.')) {
            return;
        }

        try {
            // ðŸ›‘ IMPORTANT: Use the correct admin endpoint path
            // This assumes your backend AdminController has a mapping for /api/admin/portfolios/{id}
            await makeRequest(`/admin/portfolios/${portfolioId}`, 'DELETE', null, true);

            // This runs successfully because the backend should return 204 No Content
            showMessage('Portfolio deleted successfully!', 'success');

        }  catch (error) {
        // Check if the error is the expected JSON parsing failure for a successful operation
        if (error.message && error.message.includes('Portfolio deleted successfully.')) {
            // It's the expected *successful* error. Treat as success.
            showMessage('Portfolio deleted successfully.', 'success');
        } else {
            // It's a real failure
            showMessage('Failed to delete property: ' + error.message, 'error');
            return; // Stop here if it's a real failure
        }
    }

        // Refresh the list after successful deletion
        await loadPortfolios();
        searchPortfolios();
    }


  async function toggleFavorite(portfolioId, button) {
    if (!isAuthenticated()) {
        showMessage('Please login to save favorites', 'error');
        return;
    }

    // Determine the action we are attempting: REMOVE or ADD
    const isRemoving = userFavorites.has(portfolioId);

    // Define the expected success messages for error interception
    const expectedSuccessRemoveMessage = 'removed from favorites';
    const expectedSuccessAddMessage = 'added to favorites';

    try {
        if (isRemoving) {
            // --- DELETE logic (Remove Favorite) ---
            const favorites = await makeRequest('/favorites', 'GET', null, true);
            // Find the favorite entry ID to delete it
            const favorite = favorites.find(f => f.portfolio && Number(f.portfolio.id) === Number(portfolioId));

            if (favorite) {
                // The DELETE request that may throw the "fake" error
                await makeRequest(`/favorites/${favorite.id}`, 'DELETE', null, true);

                // If it passes the try block (e.g., server returned 204 or valid JSON)
                userFavorites.delete(portfolioId);
                button.classList.remove('active');
                showMessage('Removed from favorites', 'success');
            }
        } else {
            // --- POST logic (Add Favorite) ---
            // The POST request that may throw the "fake" error
            await makeRequest(`/favorites/portfolio/${portfolioId}`, 'POST', null, true);

            // If it passes the try block
            userFavorites.add(portfolioId);
            button.classList.add('active');
            showMessage('Added to favorites', 'success');
        }
    } catch (error) {
        // --- ðŸ›‘ THE GENERALIZED FIX: Check the thrown error message ---
        const errorMessage = error.message ? error.message.toLowerCase() : '';
        let isSuccessError = false;

        if (isRemoving && errorMessage.includes(expectedSuccessRemoveMessage)) {
            // Case 1: We tried to REMOVE, and the error contains "removed from favorites"
            isSuccessError = true;
            userFavorites.delete(portfolioId);
            button.classList.remove('active');
            showMessage('Removed from favorites', 'success');
        }
        else if (!isRemoving && errorMessage.includes(expectedSuccessAddMessage)) {
            // Case 2: We tried to ADD, and the error contains "added to favorites"
            isSuccessError = true;
            userFavorites.add(portfolioId);
            button.classList.add('active');
            showMessage('Added to favorites', 'success');
        }

        // If it wasn't one of the expected "success errors", it's a genuine failure
        if (!isSuccessError) {
            showMessage('Failed to update favorites: ' + error.message, 'error');
        }
    }
}
    function sortPortfolios() {
        const sortBy = document.getElementById('sortBy').value;

        if (sortBy === 'experience') {
            filteredPortfolios.sort((a, b) => (b.year_of_exp || 0) - (a.year_of_exp || 0));
        } else if (sortBy === 'name') {
            filteredPortfolios.sort((a, b) => (a.title || '').localeCompare(b.title || ''));
        } else if (sortBy === 'newest') {
            filteredPortfolios = [...allPortfolios];
        }

        displayPortfolios();
    }

    function searchPortfolios() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        if (searchTerm.trim() === '') {
            filteredPortfolios = [...allPortfolios];
        } else {
            filteredPortfolios = allPortfolios.filter(portfolio =>
                (portfolio.title && portfolio.title.toLowerCase().includes(searchTerm)) ||
                (portfolio.description && portfolio.description.toLowerCase().includes(searchTerm)) ||
                (portfolio.category && portfolio.category.toLowerCase().includes(searchTerm))
            );
        }

        sortPortfolios();
    }

    function viewPortfolio(portfolioId) {
        window.location.href = `portfolio-detail.html?id=${portfolioId}`;
    }
</script>
</body>
</html>