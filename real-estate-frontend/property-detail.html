<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Detail - PropertyHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <i class="fas fa-home"></i>
                    PropertyHub
                </a>
            </div>
            <div class="nav-menu">
                <a href="properties.html" class="nav-link">Browse Properties</a>
                <a href="portfolios.html" class="nav-link">Browse Portfolios</a>
                <div class="auth-buttons" id="authButtons">
                    <a href="login.html" class="btn btn-outline">Login</a>
                    <a href="register.html" class="btn btn-primary">Register</a>
                </div>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
                    <button class="btn btn-outline" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Property Detail -->
    <div class="container">
        <div class="breadcrumb">
            <a href="properties.html">Properties</a>
            <span class="separator">></span>
            <span class="current">Property Details</span>
        </div>

        <div class="loading" id="propertyLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading property...
        </div>

        <div class="property-detail" id="propertyDetail" style="display: none;">
            <!-- Property details will be loaded here -->
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container"></div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            loadPropertyDetail();
        });

        async function loadPropertyDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('id');
            
            if (!propertyId) {
                window.location.href = 'properties.html';
                return;
            }

            const loadingElement = document.getElementById('propertyLoading');
            const detailElement = document.getElementById('propertyDetail');
            
            try {
                const property = await makeRequest(`/properties/${propertyId}`, 'GET', null, true);
                
                loadingElement.style.display = 'none';
                detailElement.style.display = 'block';
                
                detailElement.innerHTML = `
                    <div class="property-header">
                        <h1>${property.title}</h1>
                        <div class="property-price-location">
                            <span class="price">$${Number(property.price).toLocaleString()}</span>
                            <span class="location"><i class="fas fa-map-marker-alt"></i> ${property.location}</span>
                        </div>
                    </div>

                    <div class="property-images">
    ${property.imageUrls && property.imageUrls.length > 0 ? `
    <div class="portfolio-work">
        <h2>Work Images</h2>
        <div class="carousel">
            <div class="carousel-track">
                ${property.imageUrls.map(img => `
                    <div class="carousel-slide">
                        <img src="${getImageUrl(img)}" alt="Work image">
                    </div>
                `).join('')}
            </div>
            ${property.imageUrls.length > 1 ? `
                <button class="carousel-btn prev">&#10094;</button>
                <button class="carousel-btn next">&#10095;</button>
            ` : ''}
        </div>
    </div>
` : '<p class="empty-state">No work images uploaded.</p>'}

</div>


                    <div class="property-content">
                        <div class="property-description">
                            <h2>Description</h2>
                            <p>${property.description}</p>
                        </div>

                        <div class="property-details">
                            <h2>Property Details</h2>
                            <div class="details-grid">
    <div class="detail-item">
        <strong>Price:</strong> ${Number(property.price).toLocaleString()}
    </div>
    <div class="detail-item">
        <strong>Location:</strong> ${property.location}
    </div>
    <div class="detail-item">
        <strong>BHK:</strong> ${property.bhk || '-'}
    </div>
    <div class="detail-item">
        <strong>Facing:</strong> ${property.facing || '-'}
    </div>
    <div class="detail-item">
        <strong>Property Type:</strong> ${property.prop_type || '-'}
    </div>
    <div class="detail-item">
        <strong>Sqft:</strong> ${property.sqft ? property.sqft + ' sqft' : '-'}
    </div>
    <div class="detail-item">
        <strong>Sale/Rent:</strong> ${property.type || '-'}
    </div>
    <div class="detail-item">
        <strong>Listed on:</strong> ${new Date(property.createdAt || Date.now()).toLocaleDateString()}
    </div>
</div>

                        </div>

                        <div class="property-actions">
                            <button class="btn btn-primary" onclick="openContactForm(${property.id})">
                            <i class="fas fa-envelope"></i> Contact Owner
                            </button>
                            <button class="btn btn-outline" onclick="window.history.back()">
                                <i class="fas fa-arrow-left"></i> Back to Properties
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                loadingElement.style.display = 'none';
                detailElement.style.display = 'block';
                detailElement.innerHTML = `
                    <div class="error-state">
                        <h2>Property Not Found</h2>
                        <p>The property you're looking for doesn't exist or has been removed.</p>
                        <a href="properties.html" class="btn btn-primary">Back to Properties</a>
                    </div>
                `;
            }
        }

        function changeMainImage(imageSrc) {
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.image-thumbnails img');
            
            mainImage.src = imageSrc;
            
            thumbnails.forEach(thumb => {
                thumb.classList.toggle('active', thumb.src === imageSrc);
            });
        }

        function openContactForm(propertyId) {
    if (!isAuthenticated()) {
        showMessage('Please login to contact the property owner.', 'error');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        return;
    }
    // Redirect to contact.html with propertyId as query param
    window.location.href = `contact.html?propertyId=${propertyId}`;
}


document.addEventListener('DOMContentLoaded', function() {
    updateNavigation();
    loadPropertyDetail();

    // Show success message if redirected from contact.html
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('msg') === 'success') {
        showMessage('Message sent successfully!', 'success');
    }
});

        async function contactOwner(userId) {
            if (!isAuthenticated()) {
                showMessage('Please login to contact the property owner.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            const message = prompt('Enter your message to the property owner:');
            if (!message) return;
            
            try {
                await makeRequest('/contact', 'POST', {
                    recipientId: userId,
                    message: message
                });
                
                showMessage('Message sent successfully!', 'success');
            } catch (error) {
                showMessage('Failed to send message: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
