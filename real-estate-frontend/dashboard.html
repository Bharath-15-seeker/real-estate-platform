<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PropertyHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<!-- Navigation -->
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <a href="index.html">
                <i class="fas fa-home"></i>
                PropertyHub
            </a>
        </div>
        <div class="nav-menu">
            <a href="properties.html" class="nav-link">Browse Properties</a>
            <a href="portfolios.html" class="nav-link">Browse Portfolios</a>
            <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<!-- Dashboard Content -->
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome to Your Dashboard</h1>
        <p>Manage your properties and portfolio</p>
    </div>

    <!-- Dashboard Tabs -->
    <div class="tabs">
        <button class="tab-button active" data-tab="properties">My Properties</button>
        <button class="tab-button" data-tab="portfolio">My Portfolio</button>
        <button class="tab-button" data-tab="add-property">Add Property</button>
        <button class="tab-button" data-tab="add-portfolio">Add Portfolio</button>
    </div>

    <!-- Properties Tab -->
    <div class="tab-content active" id="properties-tab">
        <div class="section-header">
            <h2>My Properties</h2>
            <button class="btn btn-primary" onclick="switchTab('add-property')">
                <i class="fas fa-plus"></i> Add Property
            </button>
        </div>

        <div class="loading" id="propertiesLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading properties...
        </div>

        <div class="properties-grid" id="userProperties">
            <!-- Properties will be loaded here -->
        </div>
    </div>


    <!-- My Portfolio Tab -->
    <div class="tab-content" id="portfolio-tab">
        <div class="section-header">
            <h2>My Portfolios</h2>
        </div>
        <div class="loading" id="portfolioLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading portfolios...
        </div>
        <div class="portfolio-grid" id="userPortfolios">
            <!-- Portfolio cards will load here -->
        </div>
    </div>


    <!-- Add Portfolio Tab -->
    <div class="tab-content" id="add-portfolio-tab">
        <div class="section-header">
            <h2>Add New Portfolio</h2>
        </div>

        <form id="portfolioForm" class="portfolio-form">
            <div class="form-group">
                <label for="portfolioTitle">Title</label>
                <input type="text" id="portfolioTitle" name="title" required>
            </div>

            <div class="form-group">
                <label for="portfolioDescription">Description</label>
                <textarea id="portfolioDescription" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="portfolioCategory">Category</label>
                <select id="portfolioCategory" name="category" required>
                    <option value="ARCHITECT">Architect</option>
                    <option value="DESIGNER">Designer</option>
                    <option value="CIVIL_ENGINEER">Civil Engineer</option>
                    <option value="CONTRACTOR">Contractor</option>
                </select>
            </div>

            <div class="form-group">
                <label for="portfolioExperience">Years of Experience</label>
                <input type="number" id="portfolioExperience" name="year_of_exp" min="0" max="50" required>
            </div>

            <div class="form-group">
                <label for="portfolioPublic">Visibility</label>
                <select id="portfolioPublic" name="isPublic" required>
                    <option value="true">Public</option>
                    <option value="false">Private</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dp">Profile Picture</label>
                <input type="file" id="dp" name="dp" accept="image/*">
            </div>

            <div class="form-group">
                <label for="workimages">Work Images</label>
                <input type="file" id="workimages" name="workimages" multiple accept="image/*">
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Save Portfolio</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Saving...
            </span>
            </button>
        </form>
    </div>
    <!-- Add Property Tab -->
    <div class="tab-content" id="add-property-tab">
        <div class="section-header">
            <h2>Add New Property</h2>
        </div>

        <form id="propertyForm" class="property-form">
            <div class="form-group">
                <label for="title">Property Title</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="Address">Address</label>
                <textarea id="Address" name="Address" rows="4" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="price">Price ($)</label>
                    <input type="number" id="price" name="price" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" required>
                </div>
            </div>

            <!-- Extra fields -->
            <div class="form-row">
                <div class="form-group">
                    <label for="bhk">BHK</label>
                    <input type="number" id="bhk" name="bhk" min="1" required>
                </div>

                <div class="form-group">
                    <label for="facing">Facing</label>
                    <select id="facing" name="facing" required>
                        <option value="EAST">East</option>
                        <option value="WEST">West</option>
                        <option value="NORTH">North</option>
                        <option value="SOUTH">South</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="prop_type">Property Type</label>
                    <select id="prop_type" name="prop_type" required>
                        <option value="GATEDCOMMUNITYVILLA">Gated Community Villa</option>
                        <option value="APARTMENT">Apartment</option>
                        <option value="STANDALONEBUILDING">Standalone Building</option>
                        <option value="INDEPENDENTHOUSE">Independent House</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sqft">Square Feet</label>
                    <input type="number" id="sqft" name="sqft" min="0" required>
                </div>
            </div>

            <div class="form-group">
                <label for="type">Listing Type</label>
                <select id="type" name="type" required>
                    <option value="RENT">Rent</option>
                    <option value="SALE">Sale</option>
                </select>
            </div>
            <!-- End extra fields -->

            <div class="form-group">
                <label for="images">Property Images</label>
                <input type="file" id="images" name="images" multiple accept="image/*">
                <small class="form-help">Select multiple images (max 10MB each)</small>
            </div>

            <!-- UPDATED COORDINATE INPUTS AND LOCATION BUTTONS -->
            <div class="form-group">
                <label>Property Coordinates</label>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 10.7905" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 78.7047" required>
                    </div>
                </div>
                <div class="form-row" style="gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" class="btn btn-outline" onclick="selectLocation()" style="flex: 1;">
                        <i class="fas fa-location-arrow"></i> Use Current Location
                    </button>
                    <!-- New button/link to open Google Maps -->
                    <a href="https://maps.google.com" target="_blank" class="btn btn-primary" style="flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; background-color: #4285F4; color: white;">
                        <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i> Open Google Maps
                    </a>
                </div>
                <!-- UPDATED INSTRUCTION TEXT FOR SIMPLICITY -->
                <small class="form-help">
                    Use **Current Location** for one-click pinning, or use **Open Google Maps** to manually find coordinates.
                </small>
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Add Property</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Adding property...
            </span>
            </button>
        </form>
    </div>

    <script>
        // Placeholder for showMessage, assuming style.css defines the look
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) return; // Exit if container not found

            const messageElement = document.createElement('div');
            // Assuming 'message', 'info', 'success', 'error' classes are styled in style.css
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            container.appendChild(messageElement);

            // Auto-remove message after 5 seconds
            setTimeout(() => {
                if (container.contains(messageElement)) {
                    container.removeChild(messageElement);
                }
            }, 5000);
        }

        /**
         * Uses the Geolocation API to find the user's current location
         * and pre-fill the latitude and longitude fields.
         */
        function selectLocation() {
            if (navigator.geolocation) {
                // Show temporary message while loading and request permission
                showMessage('Attempting to get current location... Please approve the browser prompt.', 'info');

                // Disable button and show loading spinner for good UX
                const locationBtn = document.querySelector('[onclick="selectLocation()"]');
                locationBtn.disabled = true;
                locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Set values with high precision (6 decimal places)
                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lng.toFixed(6);

                        showMessage(`✅ Current location successfully pinned! (${lat.toFixed(4)}, ${lng.toFixed(4)})`, 'success');

                        // Re-enable button
                        locationBtn.disabled = false;
                        locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let errorMessage = 'Failed to get current location. Please manually enter coordinates.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = '🚫 Location access denied. Enable location services and try again.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = '⚠️ Location information is unavailable.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = '⏳ Location request timed out. Please try again.';
                        }
                        showMessage(errorMessage, 'error');

                        // Re-enable button
                        locationBtn.disabled = false;
                        locationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Use Current Location';
                    },
                    // Options: high accuracy, 8-second timeout, no cached position
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            } else {
                showMessage('❌ Geolocation is not supported by this browser. Please enter coordinates manually.', 'error');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Initialize everything on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
        });
    </script>


    <!-- Property Edit Modal -->
    <div class="modal" id="editPropertyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Property</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="editPropertyForm">
                <input type="hidden" id="editPropertyId">

                <div class="form-group">
                    <label for="editTitle">Property Title</label>
                    <input type="text" id="editTitle" name="title" required>
                </div>

                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" name="description" rows="4" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrice">Price ($)</label>
                        <input type="number" id="editPrice" name="price" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="editLocation">Location</label>
                        <input type="text" id="editLocation" name="location" required>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container"></div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Initialize dashboard
            initializeTabs();
            loadUserProperties();
            loadUserPortfolio();

            // Form event listeners
            document.getElementById('propertyForm').addEventListener('submit', handleAddProperty);
            document.getElementById('portfolioForm').addEventListener('submit', handleSavePortfolio);
            document.getElementById('editPropertyForm').addEventListener('submit', handleEditProperty);
        });

        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // switchTab definition moved up for better scope/order

        async function loadUserProperties() {
            const loadingElement = document.getElementById('propertiesLoading');
            const propertiesContainer = document.getElementById('userProperties');

            try {
                const properties = await makeRequest('/properties/my-properties', 'GET');

                loadingElement.style.display = 'none';

                if (properties.length === 0) {
                    propertiesContainer.innerHTML = '<div class="empty-state">No properties found. Add your first property!</div>';
                    return;
                }

                propertiesContainer.innerHTML = properties.map(property => `
                    <div class="property-card">
                        <div class="property-images">
                            ${property.images && property.images.length > 0
                                ? `<img src="${property.images[0]}" alt="${property.title}">`
                                : '<div class="no-image"><i class="fas fa-image"></i></div>'
                            }
                        </div>
                        <div class="property-content">
                            <h3>${property.title}</h3>
                            <p class="property-description">${property.description}</p>
                            <div class="property-details">
                                <span class="property-price">$${Number(property.price).toLocaleString()}</span>
                                <span class="property-location"><i class="fas fa-map-marker-alt"></i> ${property.location}</span>
                            </div>
                            <div class="property-actions">
                                <button class="btn btn-outline btn-sm" onclick="editProperty(${property.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProperty(${property.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                loadingElement.style.display = 'none';
                propertiesContainer.innerHTML = '<div class="error-state">Failed to load properties</div>';
                showMessage('Failed to load properties: ' + error.message, 'error');
            }
        }


  async function loadUserPortfolio() {
    const loadingElement = document.getElementById('portfolioLoading');
    const portfolioContainer = document.getElementById('userPortfolios');

    try {
      const portfolios = await makeRequest('/portfolio/my', 'GET');
      loadingElement.style.display = 'none';

      if (!portfolios || portfolios.length === 0) {
        portfolioContainer.innerHTML = '<div class="empty-state">No portfolios yet. Add one!</div>';
        return;
      }

      portfolioContainer.innerHTML = portfolios.map(p => {


        return `
        <div class="portfolio-card">
          <!-- Clickable area (go to details page) -->
          <div class="portfolio-main" onclick="viewPortfolio(${p.id})" style="cursor:pointer;">
            <div class="portfolio-header">
              <div class="portfolio-avatar">
                ${p.dp
                  ? `<img src="${getImageUrl(p.dp)}" alt="${p.title}" class="avatar-img">`
                  : `<i class="fas fa-user"></i>`}
              </div>
              <div class="portfolio-info">
                <h3>${p.title || 'Untitled Portfolio'}</h3>
                <p class="portfolio-category">
                  <i class="fas fa-briefcase"></i>
                  ${p.category || 'Uncategorized'}
                </p>

              </div>
            </div>
            <p class="portfolio-description">${p.description || ''}</p>
            <div class="portfolio-details">
              <span><i class="fas fa-briefcase"></i> ${p.year_of_exp || 0} years</span>
              <span><i class="fas fa-eye"></i> ${p.isPublic ? 'Public' : 'Private'}</span>
            </div>
          </div>

          <!-- Manage Buttons -->
          <div class="portfolio-actions">
            <button class="btn btn-outline btn-sm" onclick="editPortfolio(${p.id}, event)">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="btn btn-danger btn-sm" onclick="deletePortfolio(${p.id}, event)">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
        `;
      }).join('');
    } catch (error) {
      loadingElement.style.display = 'none';
      portfolioContainer.innerHTML = '<div class="error-state">Failed to load portfolios</div>';
      showMessage('Failed to load portfolios: ' + error.message, 'error');
    }
  }

 // Redirect to details page
function viewPortfolio(portfolioId) {
    // Correctly points to the portfolio-detail.html file
    // and passes the ID as a query parameter
    window.location.href = `portfolio-detail.html?id=${portfolioId}`;
}
// Stop bubbling so clicking "Edit" or "Delete" won't trigger viewPortfolio()
function editPortfolio(id, event) {
  event.stopPropagation();
  showMessage("Edit Portfolio clicked for ID: " + id, "info");
  // TODO: open edit modal for portfolio
}

async function deletePortfolio(id, event) { // The parameter is 'id', not 'portfolioId'
  event.stopPropagation();
  // Using a custom modal is required instead of confirm(), but using confirm() for now
  // until a modal UI component is available in this file.
  if (!confirm("Are you sure you want to delete this portfolio?")) return;

  try {
    // Use the correct 'id' variable in the request URL
    await makeRequest(`/portfolio/${id}`, 'DELETE', null, true);
    showMessage("Portfolio deleted successfully!", "success");
    loadUserPortfolio();
  } catch(err) {
    showMessage("Failed to delete portfolio: " + err.message, "error");
  }
}


        async function handleAddProperty(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-block';
    submitBtn.disabled = true;

    try {
        const form = event.target;
        const formData = new FormData();

        // Read latitude and longitude from visible inputs
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');

        const latitude = parseFloat(latitudeInput.value);
        const longitude = parseFloat(longitudeInput.value);

        if (isNaN(latitude) || isNaN(longitude)) {
            showMessage('Latitude and Longitude must be valid numbers.', 'error');
            return;
        }

        // Property object as JSON blob
        const property = {
            title: form.title.value,
            address: form.Address.value,
            description: form.description.value,
            price: parseFloat(form.price.value),
            location: form.location.value,
            bhk: parseInt(form.bhk.value),
            facing: form.facing.value,
            prop_type: form.prop_type.value,
            sqft: parseInt(form.sqft.value),
            type: form.type.value,
            latitude: latitude,
            longitude: longitude
        };

        formData.append("property", new Blob([JSON.stringify(property)], { type: "application/json" }));

        // Append images
        const files = form.images.files;
        for (let i = 0; i < files.length; i++) {
            formData.append("images", files[i]);
        }

        // Send request (multipart/form-data)
        await makeRequest('/properties', 'POST', formData, true, true);

        showMessage('Property added successfully!', 'success');
        form.reset();
        loadUserProperties();
        switchTab('properties');

    } catch (error) {
        showMessage('Failed to add property: ' + error.message, 'error');
    } finally {
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
    }
}


           async function handleSavePortfolio(event) {
    event.preventDefault();

    const submitBtn = event.target.querySelector('button[type="submit"]');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');

    btnText.style.display = 'none';
    btnLoading.style.display = 'inline-block';
    submitBtn.disabled = true;

    try {
        const form = event.target;
        const formData = new FormData();

        const portfolio = {
            title: form.title.value,
            description: form.description.value,
            category: form.category.value,
            year_of_exp: parseInt(form.year_of_exp.value),
            isPublic: form.isPublic.value === "true"
        };

        formData.append("portfolio", new Blob([JSON.stringify(portfolio)], { type: "application/json" }));

        if (form.dp.files.length > 0) {
            formData.append("dp", form.dp.files[0]);
        }
        for (let i = 0; i < form.workimages.files.length; i++) {
            formData.append("workimages", form.workimages.files[i]);
        }

        await makeRequest('/portfolio', 'POST', formData, true, true);

        showMessage('Portfolio saved successfully!', 'success');
        form.reset();
        loadUserPortfolio();
        switchTab('portfolio');

    } catch (error) {
        showMessage('Failed to save portfolio: ' + error.message, 'error');
    } finally {
        btnText.style.display = 'inline-block';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
    }
}

        async function editProperty(propertyId) {
            try {
                const property = await makeRequest(`/properties/${propertyId}`, 'GET');

                document.getElementById('editPropertyId').value = property.id;
                document.getElementById('editTitle').value = property.title;
                document.getElementById('editDescription').value = property.description;
                document.getElementById('editPrice').value = property.price;
                document.getElementById('editLocation').value = property.location;

                document.getElementById('editPropertyModal').style.display = 'block';

            } catch (error) {
                showMessage('Failed to load property details: ' + error.message, 'error');
            }
        }

        async function handleEditProperty(event) {
            event.preventDefault();

            const propertyId = document.getElementById('editPropertyId').value;
            const formData = new FormData(event.target);

            try {
                const propertyData = {
                    title: formData.get('title'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    location: formData.get('location')
                };

                await makeRequest(`/properties/${propertyId}`, 'PUT', propertyData);

                showMessage('Property updated successfully!', 'success');
                closeEditModal();
                loadUserProperties();

            } catch (error) {
                showMessage('Failed to update property: ' + error.message, 'error');
            }
        }

        async function deleteProperty(propertyId) {
            // Using a custom modal is required instead of confirm(), but using confirm() for now
            // until a modal UI component is available in this file.
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    await makeRequest(`/properties/${propertyId}`, 'DELETE');
                    showMessage('Property deleted successfully!', 'success');
                    loadUserProperties();
                } catch (error) {
                    showMessage('Failed to delete property: ' + error.message, 'error');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('editPropertyModal').style.display = 'none';
        }
    </script>
</body>
</html>
