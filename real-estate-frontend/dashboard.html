<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PropertyHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <a href="index.html">
                <i class="fas fa-home"></i>
                PropertyHub
            </a>
        </div>
        <div class="nav-menu">
            <a href="properties.html" class="nav-link">Browse Properties</a>
            <a href="portfolios.html" class="nav-link">Browse Portfolios</a>
            <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome to Your Dashboard</h1>
        <p>Manage your properties and portfolio</p>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="properties">My Properties</button>
        <button class="tab-button" data-tab="portfolio">My Portfolio</button>
        <button class="tab-button" data-tab="add-property">Add Property</button>
        <button class="tab-button" data-tab="add-portfolio">Add Portfolio</button>
    </div>

    <div class="tab-content active" id="properties-tab">
        <div class="section-header">
            <h2>My Properties</h2>
            <button class="btn btn-primary" onclick="switchTab('add-property')">
                <i class="fas fa-plus"></i> Add Property
            </button>
        </div>

        <div class="loading" id="propertiesLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading properties...
        </div>

        <div class="properties-grid" id="userProperties">
        </div>
    </div>


    <div class="tab-content" id="portfolio-tab">
        <div class="section-header">
            <h2>My Portfolios</h2>
        </div>
        <div class="loading" id="portfolioLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading portfolios...
        </div>
        <div class="portfolio-grid" id="userPortfolios">
        </div>
    </div>


    <div class="tab-content" id="add-portfolio-tab">
        <div class="section-header">
            <h2>Add New Portfolio</h2>
        </div>

        <form id="portfolioForm" class="portfolio-form">
            <div class="form-group">
                <label for="portfolioTitle">Title</label>
                <input type="text" id="portfolioTitle" name="title" required>
            </div>

            <div class="form-group">
                <label for="portfolioDescription">Description</label>
                <textarea id="portfolioDescription" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="portfolioCategory">Category</label>
                <select id="portfolioCategory" name="category" required>
                    <option value="ARCHITECT">Architect</option>
                    <option value="DESIGNER">Designer</option>
                    <option value="CIVIL_ENGINEER">Civil Engineer</option>
                    <option value="CONTRACTOR">Contractor</option>
                </select>
            </div>

            <div class="form-group">
                <label for="portfolioExperience">Years of Experience</label>
                <input type="number" id="portfolioExperience" name="year_of_exp" min="0" max="50" required>
            </div>

            <div class="form-group">
                <label for="portfolioPublic">Visibility</label>
                <select id="portfolioPublic" name="isPublic" required>
                    <option value="true">Public</option>
                    <option value="false">Private</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dp">Profile Picture</label>
                <input type="file" id="dp" name="dp" accept="image/*">
            </div>

            <div class="form-group">
                <label for="workimages">Work Images</label>
                <input type="file" id="workimages" name="workimages" multiple accept="image/*">
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Save Portfolio</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Saving...
            </span>
            </button>
        </form>
    </div>
    <div class="tab-content" id="add-property-tab">
        <div class="section-header">
            <h2>Add New Property</h2>
        </div>

        <form id="propertyForm" class="property-form">
            <div class="form-group">
                <label for="title">Property Title</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="Address">Address</label>
                <textarea id="Address" name="Address" rows="4" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="price">Price ($)</label>
                    <input type="number" id="price" name="price" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="bhk">BHK</label>
                    <input type="number" id="bhk" name="bhk" min="1" required>
                </div>

                <div class="form-group">
                    <label for="facing">Facing</label>
                    <select id="facing" name="facing" required>
                        <option value="EAST">East</option>
                        <option value="WEST">West</option>
                        <option value="NORTH">North</option>
                        <option value="SOUTH">South</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="prop_type">Property Type</label>
                    <select id="prop_type" name="prop_type" required>
                        <option value="GATEDCOMMUNITYVILLA">Gated Community Villa</option>
                        <option value="APARTMENT">Apartment</option>
                        <option value="STANDALONEBUILDING">Standalone Building</option>
                        <option value="INDEPENDENTHOUSE">Independent House</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sqft">Square Feet</label>
                    <input type="number" id="sqft" name="sqft" min="0" required>
                </div>
            </div>

            <div class="form-group">
                <label for="type">Listing Type</label>
                <select id="type" name="type" required>
                    <option value="RENT">Rent</option>
                    <option value="SALE">Sale</option>
                </select>
            </div>
            <div class="form-group">
                <label for="images">Property Images</label>
                <input type="file" id="images" name="images" multiple accept="image/*">
                <small class="form-help">Select multiple images (max 10MB each)</small>
            </div>

            <div class="form-group">
                <label>Property Coordinates</label>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 10.7905" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 78.7047" required>
                    </div>
                </div>
                <div class="form-row" style="gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" class="btn btn-outline" onclick="selectLocation()" style="flex: 1;">
                        <i class="fas fa-location-arrow"></i> Use Current Location
                    </button>
                    <a href="https://maps.google.com" target="_blank" class="btn btn-primary" style="flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; background-color: #4285F4; color: white;">
                        <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i> Open Google Maps
                    </a>
                </div>
                <small class="form-help">
                    Use **Current Location** for one-click pinning, or use **Open Google Maps** to manually find coordinates.
                </small>
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Add Property</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Adding property...
            </span>
            </button>
        </form>
    </div>

    <script>
        // Placeholder for showMessage, assuming style.css defines the look
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) return; // Exit if container not found

            const messageElement = document.createElement('div');
            // Assuming 'message', 'info', 'success', 'error' classes are styled in style.css
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            container.appendChild(messageElement);

            // Auto-remove message after 5 seconds
            setTimeout(() => {
                if (container.contains(messageElement)) {
                    container.removeChild(messageElement);
                }
            }, 5000);
        }

        /**
         * Uses the Geolocation API to find the user's current location
         * and pre-fill the latitude and longitude fields.
         */
        /**
 * Uses the Geolocation API to find the user's current location
 * and pre-fill the specified latitude and longitude fields.
 * @param {string} latInputId - The ID of the latitude input field to update.
 * @param {string} lngInputId - The ID of the longitude input field to update.
 */
function selectLocation(latInputId = 'latitude', lngInputId = 'longitude') {
    if (navigator.geolocation) {
        // Find the specific button that was clicked to update its state
        const locationBtn = document.querySelector(`[onclick="selectLocation('${latInputId}', '${lngInputId}')"]`);

        // Safely determine which loading element to use, prioritizing the specific button's text
        let originalButtonHtml = locationBtn ? locationBtn.innerHTML : '<i class="fas fa-location-arrow"></i> Use Current Location';

        showMessage('Attempting to get current location... Please approve the browser prompt.', 'info');

        if (locationBtn) {
            locationBtn.disabled = true;
            locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Set values for the specified input IDs
                document.getElementById(latInputId).value = lat.toFixed(6);
                document.getElementById(lngInputId).value = lng.toFixed(6);

                showMessage(`âœ… Current location successfully pinned! (${lat.toFixed(4)}, ${lng.toFixed(4)})`, 'success');

                // Re-enable button
                if (locationBtn) {
                    locationBtn.disabled = false;
                    locationBtn.innerHTML = originalButtonHtml;
                }
            },
            (error) => {
                console.error("Geolocation error:", error);
                let errorMessage = 'Failed to get current location. Please manually enter coordinates.';
                if (error.code === error.PERMISSION_DENIED) {
                    errorMessage = 'ðŸš« Location access denied. Enable location services and try again.';
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    errorMessage = 'âš ï¸ Location information is unavailable.';
                } else if (error.code === error.TIMEOUT) {
                    errorMessage = 'â³ Location request timed out. Please try again.';
                }
                showMessage(errorMessage, 'error');

                // Re-enable button
                if (locationBtn) {
                    locationBtn.disabled = false;
                    locationBtn.innerHTML = originalButtonHtml;
                }
            },
            { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
        );
    } else {
        showMessage('âŒ Geolocation is not supported by this browser. Please enter coordinates manually.', 'error');
    }
}

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Initialize everything on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
        });
    </script>


    <div class="modal" id="editPropertyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Property</h3>
                <span class="close" onclick="closeEditModal()">Ã—</span>
            </div>
            <form id="editPropertyForm">
                <input type="hidden" id="editPropertyId" name="id">

                <div class="form-group">
                    <label for="editTitle">Property Title</label>
                    <input type="text" id="editTitle" name="title" required>
                </div>

                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" name="description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" name="Address" rows="4" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrice">Price ($)</label>
                        <input type="number" id="editPrice" name="price" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="editLocation">Location</label>
                        <input type="text" id="editLocation" name="location" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editBhk">BHK</label>
                        <input type="number" id="editBhk" name="bhk" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="editFacing">Facing</label>
                        <select id="editFacing" name="facing" required>
                            <option value="EAST">East</option>
                            <option value="WEST">West</option>
                            <option value="NORTH">North</option>
                            <option value="SOUTH">South</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPropType">Property Type</label>
                        <select id="editPropType" name="prop_type" required>
                            <option value="GATEDCOMMUNITYVILLA">Gated Community Villa</option>
                            <option value="APARTMENT">Apartment</option>
                            <option value="STANDALONEBUILDING">Standalone Building</option>
                            <option value="INDEPENDENTHOUSE">Independent House</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editSqft">Square Feet</label>
                        <input type="number" id="editSqft" name="sqft" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editType">Listing Type</label>
                    <select id="editType" name="type" required>
                        <option value="RENT">Rent</option>
                        <option value="SALE">Sale</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Existing Images (Click 'Remove' to delete)</label>
                    <div id="editExistingImages" class="existing-images-container">
                    </div>
                    <input type="hidden" id="imagesToDelete" name="imagesToDelete" value="">
                </div>

                <div class="form-group">
                    <label for="editImages">Add New Images</label>
                    <input type="file" id="editImages" name="images" multiple accept="image/*">
                    <small class="form-help">Select new images (existing images are listed above)</small>
                </div>

                <div class="form-group">
                    <label>Property Coordinates</label>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="editLatitude">Latitude</label>
                            <input type="number" id="editLatitude" name="latitude" step="any" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="editLongitude">Longitude</label>
                            <input type="number" id="editLongitude" name="longitude" step="any" required>
                        </div>
                    </div>
                    <div class="form-row" style="gap: 0.5rem; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-outline" onclick="selectLocation('editLatitude', 'editLongitude')" style="flex: 1;">
                            <i class="fas fa-location-arrow"></i> Use Current Location
                        </button>
                        <a href="https://maps.google.com" target="_blank" class="btn btn-primary" style="flex: 1; text-align: center; display: flex; align-items: center; justify-content: center; background-color: #4285F4; color: white;">
                            <i class="fas fa-map-marker-alt" style="margin-right: 0.5rem;"></i> Open Google Maps
                        </a>
                    </div>
                    <small class="form-help">
                        Use **Current Location** for one-click pinning.
                    </small>
                </div>



                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Save Changes</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageContainer" class="message-container"></div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Initialize dashboard
            initializeTabs();
            loadUserProperties();
            loadUserPortfolio();

            // Form event listeners
            document.getElementById('propertyForm').addEventListener('submit', handleAddProperty);
            document.getElementById('portfolioForm').addEventListener('submit', handleSavePortfolio);
            // UPDATED EVENT LISTENER
            document.getElementById('editPropertyForm').addEventListener('submit', handleEditProperty);
        });

        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // switchTab definition moved up for better scope/order

        async function loadUserProperties() {
            const loadingElement = document.getElementById('propertiesLoading');
            const propertiesContainer = document.getElementById('userProperties');

            try {
                const properties = await makeRequest('/properties/my-properties', 'GET');

                loadingElement.style.display = 'none';

                if (properties.length === 0) {
                    propertiesContainer.innerHTML = '<div class="empty-state">No properties found. Add your first property!</div>';
                    return;
                }

                propertiesContainer.innerHTML = properties.map(property => `
                    <div class="property-card" onclick="viewProperty(${property.id})" style="cursor:pointer;">
                        <div class="property-images">
                    ${property.imageUrls && property.imageUrls.length > 0
                        ? `<img src="${getImageUrl(property.imageUrls[0])}" alt="${property.title || (property.bhk + ' BHK in ' + property.location)}">`
                        : '<div class="no-image"><i class="fas fa-image"></i></div>'
                    }
                </div>
                        <div class="property-content">
                            <h3>${property.title}</h3>
                            <p class="property-description">${property.description}</p>
                            <div class="property-details">
                                <span class="property-price">$${Number(property.price).toLocaleString()}</span>
                                <span class="property-location"><i class="fas fa-map-marker-alt"></i> ${property.location}</span>
                            </div>
                            <div class="property-actions">
                                <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); editProperty(${property.id});">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteProperty(${property.id});">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                loadingElement.style.display = 'none';
                propertiesContainer.innerHTML = '<div class="error-state">Failed to load properties</div>';
                showMessage('Failed to load properties: ' + error.message, 'error');
            }
        }


        async function loadUserPortfolio() {
            const loadingElement = document.getElementById('portfolioLoading');
            const portfolioContainer = document.getElementById('userPortfolios');

            try {
                const portfolios = await makeRequest('/portfolio/my', 'GET');
                loadingElement.style.display = 'none';

                if (!portfolios || portfolios.length === 0) {
                    portfolioContainer.innerHTML = '<div class="empty-state">No portfolios yet. Add one!</div>';
                    return;
                }

                portfolioContainer.innerHTML = portfolios.map(p => {


                    return `
                    <div class="portfolio-card">
                    <div class="portfolio-main" onclick="viewPortfolio(${p.id})" style="cursor:pointer;">
                        <div class="portfolio-header">
                        <div class="portfolio-avatar">
                            ${p.dp
                            ? `<img src="${getImageUrl(p.dp)}" alt="${p.title}" class="avatar-img">`
                            : `<i class="fas fa-user"></i>`}
                        </div>
                        <div class="portfolio-info">
                            <h3>${p.title || 'Untitled Portfolio'}</h3>
                            <p class="portfolio-category">
                            <i class="fas fa-briefcase"></i>
                            ${p.category || 'Uncategorized'}
                            </p>

                        </div>
                        </div>
                        <p class="portfolio-description">${p.description || ''}</p>
                        <div class="portfolio-details">
                        <span><i class="fas fa-briefcase"></i> ${p.year_of_exp || 0} years</span>
                        <span><i class="fas fa-eye"></i> ${p.isPublic ? 'Public' : 'Private'}</span>
                        </div>
                    </div>

                    <div class="portfolio-actions">
                        <button class="btn btn-outline btn-sm" onclick="editPortfolio(${p.id}, event)">
                        <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePortfolio(${p.id}, event)">
                        <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    </div>
                    `;
                }).join('');
            } catch (error) {
                loadingElement.style.display = 'none';
                portfolioContainer.innerHTML = '<div class="error-state">Failed to load portfolios</div>';
                showMessage('Failed to load portfolios: ' + error.message, 'error');
            }
        }

        function viewProperty(propertyId) {
            // Redirects to property-detail.html, passing the ID as a query parameter
            window.location.href = `property-detail.html?id=${propertyId}`;
        }
        // Redirect to details page
        function viewPortfolio(portfolioId) {
            // Correctly points to the portfolio-detail.html file
            // and passes the ID as a query parameter
            window.location.href = `portfolio-detail.html?id=${portfolioId}`;
        }
        // Stop bubbling so clicking "Edit" or "Delete" won't trigger viewPortfolio()
        function editPortfolio(id, event) {
            event.stopPropagation();
            showMessage("Edit Portfolio clicked for ID: " + id, "info");
            // TODO: open edit modal for portfolio
        }

        async function deletePortfolio(id, event) { // The parameter is 'id', not 'portfolioId'
            event.stopPropagation();
            // Using a custom modal is required instead of confirm(), but using confirm() for now
            // until a modal UI component is available in this file.
            if (!confirm("Are you sure you want to delete this portfolio?")) return;

            try {
                // Use the correct 'id' variable in the request URL
                await makeRequest(`/portfolio/${id}`, 'DELETE', null, true);
                showMessage("Portfolio deleted successfully!", "success");
                loadUserPortfolio();
            } catch(err) {
                showMessage("Failed to delete portfolio: " + err.message, "error");
            }
        }


        async function handleAddProperty(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const form = event.target;
                const formData = new FormData();

                // Read latitude and longitude from visible inputs
                const latitudeInput = document.getElementById('latitude');
                const longitudeInput = document.getElementById('longitude');

                const latitude = parseFloat(latitudeInput.value);
                const longitude = parseFloat(longitudeInput.value);

                if (isNaN(latitude) || isNaN(longitude)) {
                    showMessage('Latitude and Longitude must be valid numbers.', 'error');
                    return;
                }

                // Property object as JSON blob
                const property = {
                    title: form.title.value,
                    address: form.Address.value,
                    description: form.description.value,
                    price: parseFloat(form.price.value),
                    location: form.location.value,
                    bhk: parseInt(form.bhk.value),
                    facing: form.facing.value,
                    prop_type: form.prop_type.value,
                    sqft: parseInt(form.sqft.value),
                    type: form.type.value,
                    latitude: latitude,
                    longitude: longitude
                };

                formData.append("property", new Blob([JSON.stringify(property)], { type: "application/json" }));

                // Append images
                const files = form.images.files;
                for (let i = 0; i < files.length; i++) {
                    formData.append("images", files[i]);
                }

                // Send request (multipart/form-data)
                await makeRequest('/properties', 'POST', formData, true, true);

                showMessage('Property added successfully!', 'success');
                form.reset();
                loadUserProperties();
                switchTab('properties');

            } catch (error) {
                showMessage('Failed to add property: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }


        async function handleSavePortfolio(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const form = event.target;
                const formData = new FormData();

                const portfolio = {
                    title: form.title.value,
                    description: form.description.value,
                    category: form.category.value,
                    year_of_exp: parseInt(form.year_of_exp.value),
                    isPublic: form.isPublic.value === "true"
                };

                formData.append("portfolio", new Blob([JSON.stringify(portfolio)], { type: "application/json" }));

                if (form.dp.files.length > 0) {
                    formData.append("dp", form.dp.files[0]);
                }
                for (let i = 0; i < form.workimages.files.length; i++) {
                    formData.append("workimages", form.workimages.files[i]);
                }

                await makeRequest('/portfolio', 'POST', formData, true, true);

                showMessage('Portfolio saved successfully!', 'success');
                form.reset();
                loadUserPortfolio();
                switchTab('portfolio');

            } catch (error) {
                showMessage('Failed to save portfolio: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // NEW UTILITY FUNCTION TO MARK IMAGE FOR DELETION
        function removeImage(imageContainer, imageUrl) {
            // 1. Mark the URL for deletion on form submission
            const deleteInput = document.getElementById('imagesToDelete');
            const urlsToDelete = deleteInput.value ? deleteInput.value.split(',') : [];

            // Add the image URL (key) to the list
            urlsToDelete.push(imageUrl);
            deleteInput.value = urlsToDelete.join(',');

            // 2. Hide the image visually
            imageContainer.style.display = 'none';
            showMessage('Image marked for removal on save.', 'info');
        }

        // UPDATED: LOADS ALL FIELDS
        async function editProperty(propertyId) {
            try {
                const property = await makeRequest(`/properties/${propertyId}`, 'GET');

                // Populate basic text/number fields
                document.getElementById('editPropertyId').value = property.id;
                document.getElementById('editTitle').value = property.title;
                document.getElementById('editDescription').value = property.description;
                document.getElementById('editAddress').value = property.address;
                document.getElementById('editPrice').value = property.price;
                document.getElementById('editLocation').value = property.location;
                document.getElementById('editBhk').value = property.bhk;
                document.getElementById('editSqft').value = property.sqft;
                document.getElementById('editLatitude').value = property.latitude;
                document.getElementById('editLongitude').value = property.longitude;

                // Populate dropdowns
                document.getElementById('editFacing').value = property.facing;
                document.getElementById('editPropType').value = property.prop_type;
                document.getElementById('editType').value = property.type;

                // Reset image deletion tracker and new image input
                document.getElementById('imagesToDelete').value = '';
                document.getElementById('editImages').value = '';

                // Handle existing images
                const existingImagesContainer = document.getElementById('editExistingImages');
                existingImagesContainer.innerHTML = ''; // Clear previous images

                if (property.imageUrls && property.imageUrls.length > 0) {
                    property.imageUrls.forEach(urlKey => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'existing-image-item';
                        // Assumes getImageUrl function generates the full path
                        imgContainer.innerHTML = `
                            <img src="${getImageUrl(urlKey)}" alt="Property Image">
                            <button type="button" class="remove-image-btn" onclick="removeImage(this.parentNode, '${urlKey}')">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        `;
                        existingImagesContainer.appendChild(imgContainer);
                    });
                } else {
                    existingImagesContainer.innerHTML = '<p class="form-help">No existing images.</p>';
                }

                document.getElementById('editPropertyModal').style.display = 'block';

            } catch (error) {
                showMessage('Failed to load property details: ' + error.message, 'error');
            }
        }

        // UPDATED: SUBMITS ALL FIELDS AND HANDLES IMAGE DELETION/ADDITION
        async function handleEditProperty(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const propertyId = document.getElementById('editPropertyId').value;
                const form = event.target;
                const formData = new FormData();

                // 1. Get image deletion list
                const imagesToDelete = document.getElementById('imagesToDelete').value;

                // 2. Create updated property object
                const updatedProperty = {
                    title: form.title.value,
                    address: form.Address.value,
                    description: form.description.value,
                    price: parseFloat(form.price.value),
                    location: form.location.value,
                    bhk: parseInt(form.bhk.value),
                    facing: form.facing.value,
                    prop_type: form.prop_type.value,
                    sqft: parseInt(form.sqft.value),
                    type: form.type.value,
                    latitude: parseFloat(form.latitude.value),
                    longitude: parseFloat(form.longitude.value),
                    // The imagesToDelete field tells the backend which existing images to remove
                    imagesToDelete: imagesToDelete ? imagesToDelete.split(',') : []
                };

                // Append the JSON property object to FormData
                formData.append("property", new Blob([JSON.stringify(updatedProperty)], { type: "application/json" }));

                // 3. Append new images (if any)
                const newFiles = form.images.files;
                for (let i = 0; i < newFiles.length; i++) {
                    formData.append("images", newFiles[i]);
                }

                // Send PUT request as multipart/form-data
                await makeRequest(`/properties/${propertyId}`, 'PUT', formData, true, true);

                showMessage('Property updated successfully!', 'success');
                closeEditModal();
                loadUserProperties(); // Refresh the list

            } catch (error) {
                showMessage('Failed to update property: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function deleteProperty(propertyId) {
            // Using a custom modal is required instead of confirm(), but using confirm() for now
            // until a modal UI component is available in this file.
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    await makeRequest(`/properties/${propertyId}`, 'DELETE');
                    showMessage('Property deleted successfully!', 'success');
                    loadUserProperties();
                } catch (error) {
                    showMessage('Failed to delete property: ' + error.message, 'error');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('editPropertyModal').style.display = 'none';
        }
    </script>
</body>
</html>