<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PropertyHub</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        .map-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .map-modal-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .map-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .map-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .map-close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .map-close:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .map-container-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
        }

        .map-info-box {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 350px;
        }

        .map-info-box p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #666;
        }

        .map-info-box .coordinates {
            font-weight: 600;
            color: #2563eb;
            font-size: 15px;
        }

        .map-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            background-color: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .location-status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #059669;
            font-weight: 500;
        }

        .location-status i {
            font-size: 18px;
        }

        .map-actions {
            display: flex;
            gap: 12px;
        }

        .btn-map-save {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-map-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-map-cancel {
            background: white;
            color: #374151;
            border: 2px solid #d1d5db;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-map-cancel:hover {
            border-color: #9ca3af;
            background-color: #f9fafb;
        }

        .leaflet-container {
            cursor: crosshair;
        }

        /* Style for the select location button */
        .btn-select-location {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }

        .btn-select-location:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-select-location i {
            font-size: 16px;
        }

        /* Updated coordinate display */
        .coordinate-display {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #2563eb;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .coordinate-display i {
            color: #2563eb;
            font-size: 18px;
        }

        .coordinate-display span {
            font-weight: 600;
            color: #1e40af;
            font-size: 15px;
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <div class="nav-logo">
            <a href="index.html">
                <i class="fas fa-home"></i>
                PropertyHub
            </a>
        </div>
        <div class="nav-menu">
            <a href="properties.html" class="nav-link">Browse Properties</a>
            <a href="portfolios.html" class="nav-link">Browse Portfolios</a>
            <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome to Your Dashboard</h1>
        <p>Manage your properties and portfolio</p>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="properties">My Properties</button>
        <button class="tab-button" data-tab="portfolio">My Portfolio</button>
        <button class="tab-button" data-tab="add-property">Add Property</button>
        <button class="tab-button" data-tab="add-portfolio">Add Portfolio</button>
    </div>

    <div class="tab-content active" id="properties-tab">
        <div class="section-header">
            <h2>My Properties</h2>
            <button class="btn btn-primary" onclick="switchTab('add-property')">
                <i class="fas fa-plus"></i> Add Property
            </button>
        </div>

        <div class="loading" id="propertiesLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading properties...
        </div>

        <div class="properties-grid" id="userProperties">
        </div>
    </div>

    <div class="tab-content" id="portfolio-tab">
        <div class="section-header">
            <h2>My Portfolios</h2>
        </div>
        <div class="loading" id="portfolioLoading">
            <i class="fas fa-spinner fa-spin"></i> Loading portfolios...
        </div>
        <div class="portfolio-grid" id="userPortfolios">
        </div>
    </div>

    <div class="tab-content" id="add-portfolio-tab">
        <div class="section-header">
            <h2>Add New Portfolio</h2>
        </div>

        <form id="portfolioForm" class="portfolio-form">
            <div class="form-group">
                <label for="portfolioTitle">Title</label>
                <input type="text" id="portfolioTitle" name="title" required>
            </div>

            <div class="form-group">
                <label for="portfolioDescription">Description</label>
                <textarea id="portfolioDescription" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="portfolioCategory">Category</label>
                <select id="portfolioCategory" name="category" required>
                    <option value="ARCHITECT">Architect</option>
                    <option value="DESIGNER">Designer</option>
                    <option value="CIVIL_ENGINEER">Civil Engineer</option>
                    <option value="CONTRACTOR">Contractor</option>
                </select>
            </div>

            <div class="form-group">
                <label for="portfolioExperience">Years of Experience</label>
                <input type="number" id="portfolioExperience" name="year_of_exp" min="0" max="50" required>
            </div>

            <div class="form-group">
                <label for="portfolioPublic">Visibility</label>
                <select id="portfolioPublic" name="isPublic" required>
                    <option value="true">Public</option>
                    <option value="false">Private</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dp">Profile Picture</label>
                <input type="file" id="dp" name="dp" accept="image/*">
            </div>

            <div class="form-group">
                <label for="workimages">Work Images</label>
                <input type="file" id="workimages" name="workimages" multiple accept="image/*">
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Save Portfolio</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Saving...
            </span>
            </button>
        </form>
    </div>

    <div class="tab-content" id="add-property-tab">
        <div class="section-header">
            <h2>Add New Property</h2>
        </div>

        <form id="propertyForm" class="property-form">
            <div class="form-group">
                <label for="title">Property Title</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" required></textarea>
            </div>

            <div class="form-group">
                <label for="Address">Address</label>
                <textarea id="Address" name="Address" rows="4" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="price">Price ($)</label>
                    <input type="number" id="price" name="price" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="bhk">BHK</label>
                    <input type="number" id="bhk" name="bhk" min="1" required>
                </div>

                <div class="form-group">
                    <label for="facing">Facing</label>
                    <select id="facing" name="facing" required>
                        <option value="EAST">East</option>
                        <option value="WEST">West</option>
                        <option value="NORTH">North</option>
                        <option value="SOUTH">South</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="prop_type">Property Type</label>
                    <select id="prop_type" name="prop_type" required>
                        <option value="GATEDCOMMUNITYVILLA">Gated Community Villa</option>
                        <option value="APARTMENT">Apartment</option>
                        <option value="STANDALONEBUILDING">Standalone Building</option>
                        <option value="INDEPENDENTHOUSE">Independent House</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sqft">Square Feet</label>
                    <input type="number" id="sqft" name="sqft" min="0" required>
                </div>
            </div>

            <div class="form-group">
                <label for="type">Listing Type</label>
                <select id="type" name="type" required>
                    <option value="RENT">Rent</option>
                    <option value="SALE">Sale</option>
                </select>
            </div>

            <div class="form-group">
                <label for="images">Property Images</label>
                <input type="file" id="images" name="images" multiple accept="image/*">
                <small class="form-help">Select multiple images (max 10MB each)</small>
            </div>

            <div class="form-group">
                <label>Property Coordinates</label>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" name="latitude" step="any" placeholder="e.g., 10.7905" required readonly>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" name="longitude" step="any" placeholder="e.g., 78.7047" required readonly>
                    </div>
                </div>

                <div id="coordinateDisplay" class="coordinate-display" style="display: none;">
                    <i class="fas fa-map-pin"></i>
                    <span>Location Pinned: <span id="displayCoords"></span></span>
                </div>

                <div class="form-row" style="gap: 0.5rem; margin-top: 0.5rem;">
                    <button type="button" class="btn btn-outline" onclick="selectLocation()" style="flex: 1;">
                        <i class="fas fa-location-arrow"></i> Use Current Location
                    </button>
                    <button type="button" class="btn-select-location" onclick="openMapModal()" style="flex: 1;">
                        <i class="fas fa-map-marked-alt"></i> Select Location on Map
                    </button>
                </div>
                <small class="form-help">
                    Use <strong>Current Location</strong> for quick GPS pinning, or <strong>Select Location on Map</strong> to choose precisely.
                </small>
            </div>

            <button type="submit" class="btn btn-primary">
                <span class="btn-text">Add Property</span>
                <span class="btn-loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> Adding property...
            </span>
            </button>
        </form>
    </div>

    <!-- Map Selection Modal -->
    <div id="mapModal" class="map-modal">
        <div class="map-modal-content">
            <div class="map-modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> Select Property Location</h3>
                <button class="map-close" onclick="closeMapModal()">&times;</button>
            </div>
            <div class="map-container-wrapper">
                <div class="map-info-box">
                    <p><i class="fas fa-info-circle"></i> Click anywhere on the map to select location</p>
                    <p class="coordinates">Coordinates: <span id="mapCoordinates">Not selected</span></p>
                </div>
                <div id="mapContainer"></div>
            </div>
            <div class="map-modal-footer">
                <div class="location-status" id="locationStatus" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Location Selected</span>
                </div>
                <div class="map-actions">
                    <button class="btn-map-cancel" onclick="closeMapModal()">Cancel</button>
                    <button class="btn-map-save" onclick="saveMapLocation()" id="saveLocationBtn" disabled>
                        <i class="fas fa-save"></i> Save Location
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Property Modal -->
    <div class="modal" id="editPropertyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Property</h3>
                <span class="close" onclick="closeEditModal()">×</span>
            </div>
            <form id="editPropertyForm">
                <input type="hidden" id="editPropertyId" name="id">

                <div class="form-group">
                    <label for="editTitle">Property Title</label>
                    <input type="text" id="editTitle" name="title" required>
                </div>

                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" name="description" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <textarea id="editAddress" name="Address" rows="4" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPrice">Price ($)</label>
                        <input type="number" id="editPrice" name="price" min="0" step="0.01" required>
                    </div>

                    <div class="form-group">
                        <label for="editLocation">Location</label>
                        <input type="text" id="editLocation" name="location" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editBhk">BHK</label>
                        <input type="number" id="editBhk" name="bhk" min="1" required>
                    </div>

                    <div class="form-group">
                        <label for="editFacing">Facing</label>
                        <select id="editFacing" name="facing" required>
                            <option value="EAST">East</option>
                            <option value="WEST">West</option>
                            <option value="NORTH">North</option>
                            <option value="SOUTH">South</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="editPropType">Property Type</label>
                        <select id="editPropType" name="prop_type" required>
                            <option value="GATEDCOMMUNITYVILLA">Gated Community Villa</option>
                            <option value="APARTMENT">Apartment</option>
                            <option value="STANDALONEBUILDING">Standalone Building</option>
                            <option value="INDEPENDENTHOUSE">Independent House</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="editSqft">Square Feet</label>
                        <input type="number" id="editSqft" name="sqft" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editType">Listing Type</label>
                    <select id="editType" name="type" required>
                        <option value="RENT">Rent</option>
                        <option value="SALE">Sale</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Existing Images (Click 'Remove' to delete)</label>
                    <div id="editExistingImages" class="existing-images-container"></div>
                    <input type="hidden" id="imagesToDelete" name="imagesToDelete" value="">
                </div>

                <div class="form-group">
                    <label for="editImages">Add New Images</label>
                    <input type="file" id="editImages" name="images" multiple accept="image/*">
                    <small class="form-help">Select new images (existing images are listed above)</small>
                </div>

                <div class="form-group">
                    <label>Property Coordinates</label>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="editLatitude">Latitude</label>
                            <input type="number" id="editLatitude" name="latitude" step="any" required readonly>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="editLongitude">Longitude</label>
                            <input type="number" id="editLongitude" name="longitude" step="any" required readonly>
                        </div>
                    </div>

                    <div id="editCoordinateDisplay" class="coordinate-display" style="display: none;">
                        <i class="fas fa-map-pin"></i>
                        <span>Location Pinned: <span id="editDisplayCoords"></span></span>
                    </div>

                    <div class="form-row" style="gap: 0.5rem; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-outline" onclick="selectLocation('editLatitude', 'editLongitude')" style="flex: 1;">
                            <i class="fas fa-location-arrow"></i> Use Current Location
                        </button>
                        <button type="button" class="btn-select-location" onclick="openMapModal('editLatitude', 'editLongitude')" style="flex: 1;">
                            <i class="fas fa-map-marked-alt"></i> Select Location on Map
                        </button>
                    </div>
                    <small class="form-help">
                        Use <strong>Current Location</strong> or select on map to update location.
                    </small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Save Changes</span>
                        <span class="btn-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageContainer" class="message-container"></div>

    <script src="script.js"></script>
    <script>
        // Map variables
        let map = null;
        let marker = null;
        let selectedLat = null;
        let selectedLng = null;
        let targetLatInput = 'latitude';
        let targetLngInput = 'longitude';

        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            if (!container) return;

            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = message;
            container.appendChild(messageElement);

            setTimeout(() => {
                if (container.contains(messageElement)) {
                    container.removeChild(messageElement);
                }
            }, 5000);
        }

        function openMapModal(latInputId = 'latitude', lngInputId = 'longitude') {
            targetLatInput = latInputId;
            targetLngInput = lngInputId;

            const modal = document.getElementById('mapModal');
            modal.style.display = 'block';

            // Initialize map after modal is visible
            setTimeout(() => {
                if (!map) {
                    initMap();
                } else {
                    map.invalidateSize();
                }

                // If coordinates already exist, show them on map
                const existingLat = parseFloat(document.getElementById(latInputId).value);
                const existingLng = parseFloat(document.getElementById(lngInputId).value);

                if (!isNaN(existingLat) && !isNaN(existingLng)) {
                    setMapLocation(existingLat, existingLng);
                    map.setView([existingLat, existingLng], 15);
                }
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('mapModal').style.display = 'none';
        }

        function initMap() {
            // Default to India center
            const defaultLat = 20.5937;
            const defaultLng = 78.9629;

            map = L.map('mapContainer').setView([defaultLat, defaultLng], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            map.on('click', function(e) {
                setMapLocation(e.latlng.lat, e.latlng.lng);
            });

            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        map.setView([userLat, userLng], 13);
                    },
                    (error) => {
                        console.log('Geolocation not available, using default location');
                    }
                );
            }
        }

        function setMapLocation(lat, lng) {
            selectedLat = lat;
            selectedLng = lng;

            if (marker) {
                map.removeLayer(marker);
            }

            marker = L.marker([lat, lng], {
                draggable: true
            }).addTo(map);

            marker.on('dragend', function(e) {
                const position = marker.getLatLng();
                setMapLocation(position.lat, position.lng);
            });

            document.getElementById('mapCoordinates').textContent =
                `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

            document.getElementById('locationStatus').style.display = 'flex';
            document.getElementById('saveLocationBtn').disabled = false;
        }

        function saveMapLocation() {
            if (selectedLat !== null && selectedLng !== null) {
                document.getElementById(targetLatInput).value = selectedLat.toFixed(6);
                document.getElementById(targetLngInput).value = selectedLng.toFixed(6);

                // Update coordinate display
                const displayElement = targetLatInput === 'latitude' ?
                    document.getElementById('coordinateDisplay') :
                    document.getElementById('editCoordinateDisplay');
                const coordsElement = targetLatInput === 'latitude' ?
                    document.getElementById('displayCoords') :
                    document.getElementById('editDisplayCoords');

                displayElement.style.display = 'flex';
                coordsElement.textContent = `${selectedLat.toFixed(4)}, ${selectedLng.toFixed(4)}`;

                showMessage(`Location saved: ${selectedLat.toFixed(4)}, ${selectedLng.toFixed(4)}`, 'success');
                closeMapModal();
            }
        }

        function selectLocation(latInputId = 'latitude', lngInputId = 'longitude') {
            if (navigator.geolocation) {
                const locationBtn = event.target;
                const originalButtonHtml = locationBtn.innerHTML;

                showMessage('Getting current location...', 'info');
                locationBtn.disabled = true;
                locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        document.getElementById(latInputId).value = lat.toFixed(6);
                        document.getElementById(lngInputId).value = lng.toFixed(6);

                        // Update coordinate display
                        const displayElement = latInputId === 'latitude' ?
                            document.getElementById('coordinateDisplay') :
                            document.getElementById('editCoordinateDisplay');
                        const coordsElement = latInputId === 'latitude' ?
                            document.getElementById('displayCoords') :
                            document.getElementById('editDisplayCoords');

                        displayElement.style.display = 'flex';
                        coordsElement.textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

                        showMessage(`✅ Current location pinned! (${lat.toFixed(4)}, ${lng.toFixed(4)})`, 'success');

                        locationBtn.disabled = false;
                        locationBtn.innerHTML = originalButtonHtml;
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        let errorMessage = 'Failed to get location. Please try map selection.';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = '🚫 Location access denied. Enable location services and try again.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = '⚠️ Location information is unavailable.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = '⏳ Location request timed out. Please try again.';
                        }
                        showMessage(errorMessage, 'error');

                        locationBtn.disabled = false;
                        locationBtn.innerHTML = originalButtonHtml;
                    },
                    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
                );
            } else {
                showMessage('❌ Geolocation is not supported by this browser.', 'error');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            initializeTabs();
            loadUserProperties();
            loadUserPortfolio();

            document.getElementById('propertyForm').addEventListener('submit', handleAddProperty);
            document.getElementById('portfolioForm').addEventListener('submit', handleSavePortfolio);
            document.getElementById('editPropertyForm').addEventListener('submit', handleEditProperty);
        });

        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        async function loadUserProperties() {
            const loadingElement = document.getElementById('propertiesLoading');
            const propertiesContainer = document.getElementById('userProperties');

            try {
                const properties = await makeRequest('/properties/my-properties', 'GET');
                loadingElement.style.display = 'none';

                if (properties.length === 0) {
                    propertiesContainer.innerHTML = '<div class="empty-state">No properties found. Add your first property!</div>';
                    return;
                }

                propertiesContainer.innerHTML = properties.map(property => `
                    <div class="property-card" onclick="viewProperty(${property.id})" style="cursor:pointer;">
                        <div class="property-images">
                    ${property.imageUrls && property.imageUrls.length > 0
                        ? `<img src="${getImageUrl(property.imageUrls[0])}" alt="${property.title || (property.bhk + ' BHK in ' + property.location)}">`
                        : '<div class="no-image"><i class="fas fa-image"></i></div>'
                    }
                </div>
                        <div class="property-content">
                            <h3>${property.title}</h3>
                            <p class="property-description">${property.description}</p>
                            <div class="property-details">
                                <span class="property-price">${Number(property.price).toLocaleString()}</span>
                                <span class="property-location"><i class="fas fa-map-marker-alt"></i> ${property.location}</span>
                            </div>
                            <div class="property-actions">
                                <button class="btn btn-outline btn-sm" onclick="event.stopPropagation(); editProperty(${property.id});">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteProperty(${property.id});">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                loadingElement.style.display = 'none';
                propertiesContainer.innerHTML = '<div class="error-state">Failed to load properties</div>';
                showMessage('Failed to load properties: ' + error.message, 'error');
            }
        }

        async function loadUserPortfolio() {
            const loadingElement = document.getElementById('portfolioLoading');
            const portfolioContainer = document.getElementById('userPortfolios');

            try {
                const portfolios = await makeRequest('/portfolio/my', 'GET');
                loadingElement.style.display = 'none';

                if (!portfolios || portfolios.length === 0) {
                    portfolioContainer.innerHTML = '<div class="empty-state">No portfolios yet. Add one!</div>';
                    return;
                }

                portfolioContainer.innerHTML = portfolios.map(p => {
                    return `
                    <div class="portfolio-card">
                    <div class="portfolio-main" onclick="viewPortfolio(${p.id})" style="cursor:pointer;">
                        <div class="portfolio-header">
                        <div class="portfolio-avatar">
                            ${p.dp
                            ? `<img src="${getImageUrl(p.dp)}" alt="${p.title}" class="avatar-img">`
                            : `<i class="fas fa-user"></i>`}
                        </div>
                        <div class="portfolio-info">
                            <h3>${p.title || 'Untitled Portfolio'}</h3>
                            <p class="portfolio-category">
                            <i class="fas fa-briefcase"></i>
                            ${p.category || 'Uncategorized'}
                            </p>
                        </div>
                        </div>
                        <p class="portfolio-description">${p.description || ''}</p>
                        <div class="portfolio-details">
                        <span><i class="fas fa-briefcase"></i> ${p.year_of_exp || 0} years</span>
                        <span><i class="fas fa-eye"></i> ${p.isPublic ? 'Public' : 'Private'}</span>
                        </div>
                    </div>
                    <div class="portfolio-actions">
                        <button class="btn btn-outline btn-sm" onclick="editPortfolio(${p.id}, event)">
                        <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePortfolio(${p.id}, event)">
                        <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    </div>
                    `;
                }).join('');
            } catch (error) {
                loadingElement.style.display = 'none';
                portfolioContainer.innerHTML = '<div class="error-state">Failed to load portfolios</div>';
                showMessage('Failed to load portfolios: ' + error.message, 'error');
            }
        }

        function viewProperty(propertyId) {
            window.location.href = `property-detail.html?id=${propertyId}`;
        }

        function viewPortfolio(portfolioId) {
            window.location.href = `portfolio-detail.html?id=${portfolioId}`;
        }

        function editPortfolio(id, event) {
            event.stopPropagation();
            showMessage("Edit Portfolio clicked for ID: " + id, "info");
        }

        async function deletePortfolio(id, event) {
            event.stopPropagation();
            if (!confirm("Are you sure you want to delete this portfolio?")) return;

            try {
                await makeRequest(`/portfolio/${id}`, 'DELETE', null, true);
                showMessage("Portfolio deleted successfully!", "success");
                loadUserPortfolio();
            } catch(err) {
                showMessage("Failed to delete portfolio: " + err.message, "error");
            }
        }

        async function handleAddProperty(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const form = event.target;
                const formData = new FormData();

                const latitudeInput = document.getElementById('latitude');
                const longitudeInput = document.getElementById('longitude');

                const latitude = parseFloat(latitudeInput.value);
                const longitude = parseFloat(longitudeInput.value);

                if (isNaN(latitude) || isNaN(longitude)) {
                    showMessage('Please select a valid location using the map or GPS.', 'error');
                    return;
                }

                const property = {
                    title: form.title.value,
                    address: form.Address.value,
                    description: form.description.value,
                    price: parseFloat(form.price.value),
                    location: form.location.value,
                    bhk: parseInt(form.bhk.value),
                    facing: form.facing.value,
                    prop_type: form.prop_type.value,
                    sqft: parseInt(form.sqft.value),
                    type: form.type.value,
                    latitude: latitude,
                    longitude: longitude
                };

                formData.append("property", new Blob([JSON.stringify(property)], { type: "application/json" }));

                const files = form.images.files;
                for (let i = 0; i < files.length; i++) {
                    formData.append("images", files[i]);
                }

                await makeRequest('/properties', 'POST', formData, true, true);

                showMessage('Property added successfully!', 'success');
                form.reset();
                document.getElementById('coordinateDisplay').style.display = 'none';
                loadUserProperties();
                switchTab('properties');

            } catch (error) {
                showMessage('Failed to add property: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleSavePortfolio(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const form = event.target;
                const formData = new FormData();

                const portfolio = {
                    title: form.title.value,
                    description: form.description.value,
                    category: form.category.value,
                    year_of_exp: parseInt(form.year_of_exp.value),
                    isPublic: form.isPublic.value === "true"
                };

                formData.append("portfolio", new Blob([JSON.stringify(portfolio)], { type: "application/json" }));

                if (form.dp.files.length > 0) {
                    formData.append("dp", form.dp.files[0]);
                }
                for (let i = 0; i < form.workimages.files.length; i++) {
                    formData.append("workimages", form.workimages.files[i]);
                }

                await makeRequest('/portfolio', 'POST', formData, true, true);

                showMessage('Portfolio saved successfully!', 'success');
                form.reset();
                loadUserPortfolio();
                switchTab('portfolio');

            } catch (error) {
                showMessage('Failed to save portfolio: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        function removeImage(imageContainer, imageUrl) {
            const deleteInput = document.getElementById('imagesToDelete');
            const urlsToDelete = deleteInput.value ? deleteInput.value.split(',') : [];
            urlsToDelete.push(imageUrl);
            deleteInput.value = urlsToDelete.join(',');
            imageContainer.style.display = 'none';
            showMessage('Image marked for removal on save.', 'info');
        }

        async function editProperty(propertyId) {
            try {
                const property = await makeRequest(`/properties/${propertyId}`, 'GET');

                document.getElementById('editPropertyId').value = property.id;
                document.getElementById('editTitle').value = property.title;
                document.getElementById('editDescription').value = property.description;
                document.getElementById('editAddress').value = property.address;
                document.getElementById('editPrice').value = property.price;
                document.getElementById('editLocation').value = property.location;
                document.getElementById('editBhk').value = property.bhk;
                document.getElementById('editSqft').value = property.sqft;
                document.getElementById('editLatitude').value = property.latitude;
                document.getElementById('editLongitude').value = property.longitude;

                document.getElementById('editFacing').value = property.facing;
                document.getElementById('editPropType').value = property.prop_type;
                document.getElementById('editType').value = property.type;

                // Show coordinate display if values exist
                if (property.latitude && property.longitude) {
                    const displayElement = document.getElementById('editCoordinateDisplay');
                    const coordsElement = document.getElementById('editDisplayCoords');
                    displayElement.style.display = 'flex';
                    coordsElement.textContent = `${parseFloat(property.latitude).toFixed(4)}, ${parseFloat(property.longitude).toFixed(4)}`;
                }

                document.getElementById('imagesToDelete').value = '';
                document.getElementById('editImages').value = '';

                const existingImagesContainer = document.getElementById('editExistingImages');
                existingImagesContainer.innerHTML = '';

                if (property.imageUrls && property.imageUrls.length > 0) {
                    property.imageUrls.forEach(urlKey => {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'existing-image-item';
                        imgContainer.innerHTML = `
                            <img src="${getImageUrl(urlKey)}" alt="Property Image">
                            <button type="button" class="remove-image-btn" onclick="removeImage(this.parentNode, '${urlKey}')">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        `;
                        existingImagesContainer.appendChild(imgContainer);
                    });
                } else {
                    existingImagesContainer.innerHTML = '<p class="form-help">No existing images.</p>';
                }

                document.getElementById('editPropertyModal').style.display = 'block';

            } catch (error) {
                showMessage('Failed to load property details: ' + error.message, 'error');
            }
        }

        async function handleEditProperty(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');

            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;

            try {
                const propertyId = document.getElementById('editPropertyId').value;
                const form = event.target;
                const formData = new FormData();

                const imagesToDelete = document.getElementById('imagesToDelete').value;

                const updatedProperty = {
                    title: form.title.value,
                    address: form.Address.value,
                    description: form.description.value,
                    price: parseFloat(form.price.value),
                    location: form.location.value,
                    bhk: parseInt(form.bhk.value),
                    facing: form.facing.value,
                    prop_type: form.prop_type.value,
                    sqft: parseInt(form.sqft.value),
                    type: form.type.value,
                    latitude: parseFloat(form.latitude.value),
                    longitude: parseFloat(form.longitude.value),
                    imagesToDelete: imagesToDelete ? imagesToDelete.split(',') : []
                };

                formData.append("property", new Blob([JSON.stringify(updatedProperty)], { type: "application/json" }));

                const newFiles = form.images.files;
                for (let i = 0; i < newFiles.length; i++) {
                    formData.append("images", newFiles[i]);
                }

                await makeRequest(`/properties/${propertyId}`, 'PUT', formData, true, true);

                showMessage('Property updated successfully!', 'success');
                closeEditModal();
                loadUserProperties();

            } catch (error) {
                showMessage('Failed to update property: ' + error.message, 'error');
            } finally {
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function deleteProperty(propertyId) {
            if (confirm('Are you sure you want to delete this property?')) {
                try {
                    await makeRequest(`/properties/${propertyId}`, 'DELETE');
                    showMessage('Property deleted successfully!', 'success');
                    loadUserProperties();
                } catch (error) {
                    showMessage('Failed to delete property: ' + error.message, 'error');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('editPropertyModal').style.display = 'none';
        }
    </script>
</body>
</html>